# [《网络协议从入门到底层原理》笔记（三）路由、网络常见概念、公网私网、NAT](https://www.cnblogs.com/wkfvawl/p/15487248.html)

# 第一章 路由

在不同网段之间转发数据，需要有路由器的支持
默认情况下，**路由器只知道跟它直连的网段**，非直连的网段需要通过 **静态路由**、**动态路由** 告诉它。

1、静态路由

-  管理员手动添加路由信息
-  适用于小规模网络

2、动态路由

- 路由器通过路由选择协议（比如RIP、OSPF）自动获取路由信息
-  适用于大规模网络

## 实践1 - 让4台主机之间可以互相通信

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200417736-1785862491.png)

路由器0的路由表：

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200534278-86889068.png)

路由器1的路由表：

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200705943-186161178.png)

 

## 实践2 - 让4台主机之间可以互相通信

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200755953-1206355593.png)

路由表

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200900022-1371180465.png)

## 数据包的传输过程（简）

这里仅仅是简述一下数据包的传输过程，后面详细学到网络分层时，会再次详细讲解数据包的传输过程。

源IP、目标IP 没有变过；源MAC、目标MAC 一直在变。

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030200959456-1044910208.png)

 

- 首先从`A`发送`ARP广播`，拿到`路由器0`的MAC地址`M0`。
- 然后从`A`的MAC地址`MA`，发送数据包到目标MAC地址，即路由器0的`M0`地址。
- `M1`的下一跳地址为`M2`，修改数据包源MAC地址为`M1`和目标MAC地址`M2`。
- `M3`发送`ARP广播`，最终数据包从`M3`发送到`MF`。

## 第一个包的丢失

如图，从 192.168.1.10/24 往 192.168.2.10/24 虽然可以 `ping` 通，但是却丢失了第一个数据包。

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030201041372-936214284.png)

 

原因是：计算机0 往路由器发送了 ARP包，路由器收到后回复了 ARP包，从而计算机0就开始发送 ICMP包，路由器0收到 ICMP包后准备发往计算机1，但是路由器还不知道计算机1的MAC地址，所以要往计算机1发送ARP包，因此就把ICMP包给丢了，所以第一次 `ping` 会超时。

> ICMP是(Internet Control Message Protocol)Internet控制[报文](https://baike.so.com/doc/6200132-6413395.html)协议。它是[TCP/IP协议族](https://baike.so.com/doc/1956074-2070055.html)的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指[网络通](https://baike.so.com/doc/7558016-7832109.html)不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。

# 第二章 网络、互联网、因特网

全世界最大的互联网是：因特网（Internet）

- 将**全世界**所有的计算机都连接在一起
- 一般使用大写 I 开头的 Internet 特指因特网
- 日常生活中说的：你的电脑上不了网。其实就是指：你的电脑没有连接到因特网。

## 2.1 ISP（互联网服务提供商）

ISP（Internet Service Provider），Internet 服务提供商，比如移动、电信、网通、铁通等。我们平时拉的宽带都是通过 ISP 连接到 Internet 的。

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202138930-490385131.png)

 

 平时见到左边的下载列表，其实是给使用不同 ISP 的用户对应的选择。

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202219800-1205847666.png)

## 2.2 网络分类

按照网络的范围进行分类，可以分为：**局域网**、**城域网**、**广域网**等

### 局域网（ Local Area Network, LAN ）

- 一般是范围在几百米到十几公里内的计算机所构成的计算机网络
- 常用于公司、家庭、学校、医院、机关、一幢大楼等
- 局域网中使用最广泛的网络技术叫：以太网（ Ethernet）
- 在电脑、手机上经常见到的一个英文 WLAN（Wireless LAN ），意思是无线局域网

### 城域网（Metropolitan Area Network，MAN）

- 一般范围是数十公里到数百公里，可以覆盖一个城市

### 广域网（Wide Area Network，WAN）

- 一般范围是几百公里到几千公里，可以覆盖一个国家。通常都需要租用 ISP 的线路。

## 2.3 常见接口（FastEthernet、GigabitEthernet、Serial）

- FastEthernet —— 快速以太网接口（100M）
- GigabitEthernet —— 千兆以太网接口（1000M）
- Serial —— 串行接口

## 2.4 上网方式

### 电话线入户

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202559359-219991651.png)
ADSL电话拨号上网（Asymmetric Digital Subscriber Line ）

- 非对称数字用户线路，提供上、下行不对称的传输带宽

**猫（ Modem）**，**调制解调器**，进行**数字信号**和**模拟信号**的转换

### 光纤入户

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202730666-1008135340.png)

光猫（ Optical Modem），**光调制解调器**，进行**数字信号**和**光信号**的转换

### 网线入户

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202813865-500771353.png)

### 家用无限路由器的逻辑结构

![img](https://img2020.cnblogs.com/blog/1358881/202110/1358881-20211030202914039-134478942.png)

## 2.5 公网IP、私网IP

IP地址也分为：公网IP、私网IP

### 公网IP（Public）

-   Internet 上的路由器中只有到达公网的路由表，没有到达私网的路由表
-   公网IP 由因特网信息中心（Internet Network Information Cetner, Inter NIC ）统一分配和管理
-   ISP 需要向 Inter NIC 申请 公网IP

### 私网IP（Private）

主要用于局域网。下面是保留的私网网段

-   A类：10.0.0.0/8，1个A类网络
-   B类：172.16.0.0/16 ~ 172.31.0.0/16，16个B类网络
-   C类：192.168.0.0/24 ~ 192.168.255.0/24，256个C类网络

## 2.6 NAT（Network Address Translation）

网络地址转换协议

> 通过使用少量的全球IP地址（公网IP地址）代表较多的私有IP地址的方式，将有助于减缓可用的IP地址空间的枯竭。

私网IP 访问 Internet 需要进行 **NAT** 转换为 公网IP，这一步可以由**路由器**完成。

### NAT 的特点

-  节约公网IP资源
-  隐藏内部真实IP

### NAT 的分类

静态转换

- 手动配置NAT映射表
- 一对一转换

动态转换

- 定义外部地址池，动态随机转换
- 一对一转换

### PAT（Port Address Translation）

- 多对一转换，最大程度节约公网IP资源
- 采用端口多路复用方式，通过端口号标识不同的数据流
- 目前应用最广泛的NAT实现方式