# [《网络协议从入门到底层原理》笔记（四）网络互联模型、物理层、数据链路层](https://www.cnblogs.com/wkfvawl/p/15519671.html)

# 第一章 网络互联模型

为了更好地促进互联网络的研究和发展，国际标准化组织 ISO 在 1985 年制定了网络互连模型

OSI 参考模型(Open System Interconnect Reference Model)，具有 7 层结构

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107130205607-267923396.png)

 TCP/IP是一个四层的体系结构，从实质上讲，只有上边三层，网络接口层没有什么具体的内容。五层协议只是OSI和TCP/IP的综合，实际应用还是TCP/IP的四层结构。为了方便可以把下两层称为网络接口层。

## 网络分层

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107133147910-1972366016.png)

##  传输过程

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107133821228-1585808359.gif)

 具体细节

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107133811268-1746244621.gif)

# 第二章 物理层

物理层定义了接口标准、线缆标准、传输速率、传输方式等

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134038327-2032745293.png)

## 2.1 数字信号与模拟信号

模拟信号（Analog Signal）

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134201118-1254362513.png)

- 连续的信号，适合长距离传输
- 抗干扰能力差，受到干扰时波形变形很难纠正

数字信号（Digital Signal）

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134225562-1376935838.png)

- 离散的信号，不适合长距离传输
- 抗干扰能力强，受到干扰时波形失真可以修复

## 2.2 数据通信模型

局域网通信模型

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134312498-399884496.png)

 广域网通信模型

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134342790-545007107.png)

## 2.3 信道

信道：信息传输的通道，一条传输介质上（比如网线）上可以有多条信道

单工通信：

- 信号只能往一个方向传输，任何时候都不能改变信号的传输方向
- 比如`无线电广播`，`有线电视广播`

半双工通信:

- 信号可以双向传输，但必须是交替进行，同一时间只能往一个方向传输
- 比如`对讲机`

全双工通信：

- 信号可以同时双向传输
- 比如`手机`

# 第三章 数据链路层

**链路**：从一个节点到相邻节点的一段物理线路（有线或无线），中间没有其他交换节点

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107134819579-181019890.png)

**数据链路**：在一条链路上传输数据时，需要有对应的通信协议来控制数据的传输

不同类型的数据链路，所用的通信协议是可能不同的

- 广播信道：CSMA/CD协议（比如同轴电缆，集线器等组成的网络）
- 点对点信道：PPP协议（比如2个路由器之间的信道）

数据链路层的3个基本问题：

- 封装成帧
- 透明传输
- 差错检验

## 3.1 封装成帧

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107135630527-1630081153.png)

> 封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
> 首部和尾部的一个重要作用就是进行帧定界。

帧（Frame）的数据部分

- 就是网络层传递下来的数据包（IP数据包，Packet）

最大传输单元**MTU**（Maximum Transfer Unit）

- 每一种数据链路层协议都规定了所能够传送的帧的数据长度上限
- 以太网的MTU为1500个字节

## 3.2 透明传输

> 透明指某一个实际存在的事物看起来却好像不存在一样。
> “在数据链路层透明传送数据”表示无论发送什么样的比特组合的数据，这些数据都能够按照原样没有差错地通过这个数据链路层。

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107135753017-220788.png)

使用**SOH**（Start Of Header）作为帧开始符
使用**EOT**（End Of Transmission）作为帧结束符

数据部分一旦出现了SOH、EOT，就需要进行转义

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107135905959-392562884.png)

## 3.3 差错检查

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107140457045-1745573622.png)

 

在数据后面添加上的冗余码称为**帧检验序列 FCS** (Frame Check Sequence)。

 

 FCS是根据数据部分 + 首部计算得出的，数据传输前和传输后都会计算FCS用来检验数据是否出错。

## 3.4 CSMA/CD协议

CSMA/CD（Carrier Sense Multiple Access with Collision Detectio）**载波侦听多路访问/冲突检测**

- “**多路**”表示许多计算机以多点接入的方式连接在一根总线上。
- “**载波监听**”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。
- 总线上并没有什么“**载波**”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。
- “**碰撞检测**”就是计算机边发送数据边检测信道上的信号电压大小。当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。

在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。

**CSMA/CD 协议工作流程**
![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107141354516-32783490.png)

使用了CSMA/CD的网络可以称为是**以太网（Ethernet）**，它传输的是**以太网帧**

-   以太网帧的格式有：Ethernet V2标准、IEEE的802.3标准
-   使用最多的是：Ethernet V2标准

为了能够检测正在发送的帧是否产生了冲突，以太网的帧至少要 64 字节

用**交换机**组建的网络，已经支持**全双工通信**，不需要再使用CSMA/CD，但它传输的帧依然是以太网帧。所以，用交换机组建的网络，依然可以叫做以太网

## 3.5 Ethernet V2帧

### Ethernet V2帧的格式

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107141534710-1566836889.png)

- 首部：`源MAC + 目标MAC + 网络类型（是IPv4还是IPv6）`
- 以太网帧：`首部 + 数据 + FCS`
- 数据的长度至少是：`64 - 6 - 6 - 2 - 4 = 46 bytes`

### Ethernet V2标准

当数据部分的长度小于`46`字节的时候

- 数据链路层会在数据的后面加入一些字节填充
- 接收端将会把添加的字节去掉

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107141720144-1467028610.png)

长度总结:

- 以太网帧的数据长度：`46~1500bytes`
- 以太网帧的长度：`64~1518bytes`（目标MAC + 源MAC + 网络类型 + 数据 + FCS）

## 3.6 网卡

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107142518016-39799131.png)

- 网卡接收到一个帧，首先会进行差错校验，如果校验通过则接收，否则丢弃
- `Wireshark`抓到的帧没有`FCS`，因为它抓到的是差错校验通过的帧，（帧尾的`FCS`会被硬件去掉）
- `Wireshark`抓不到差错校验失败的帧

## 3.7 PPP协议

对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。

PPP 协议应满足的需求

- 简单 —— 这是首要的要求。
- 封装成帧 —— 必须规定特殊的字符作为帧定界符。
- 透明性 —— 必须保证数据传输的透明性。
- 多种网络层协议 —— 能够在同一条物理链路上同时支持多种网络层协议。
- 多种类型链路 —— 能够在多种类型的链路上运行。
- 差错检测 —— 能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
- 检测连接状态 —— 能够及时自动检测出链路是否处于正常工作状态。
- 最大传送单元 —— 必须对每一种类型的点对点链路设置最大传送单元 MTU 的标准默认值，促进各种实现之间的互操作性。
- 网络层地址协商 —— 必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。
- 数据压缩协商 —— 必须提供一种方法来协商使用数据压缩算法

PPP 协议不需要的功能

- 纠错
- 流量控制
- 序号
- 多点线路
- 半双工或单工链路

PPP 协议有三个组成部分：

- 一个将 IP 数据报封装到串行链路的方法。
- 链路控制协议 LCP (Link Control Protocol)。
- 网络控制协议 NCP (Network Control Protocol)。

### PPP 协议的帧格式

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107142621791-31411590.png)

- PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。
- 标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。
- 地址字段 A 只置为 0xFF。地址字段实际上并不起作用。
- 控制字段 C 通常置为 0x03。
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。

PPP 有一个 2 个字节的协议字段。其值

- 若为 0x0021，则信息字段就是 IP 数据报。
- 若为 0x8021，则信息字段是网络控制数据。
- 若为 0xC021，则信息字段是 PPP 链路控制数据。
- 若为 0xC023，则信息字段是鉴别数据。

### 字符填充法

当 PPP 用在异步传输时，就使用一种特殊的字符填充法。
当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）

![img](https://img2020.cnblogs.com/blog/1358881/202111/1358881-20211107143237536-1996382199.png)

将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)。
若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)。
若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。